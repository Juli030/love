<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EstÃ¡ preparada para o possÃ­vel inÃ­cio da nossa turnÃª? ğŸ¸</title>
  <style>
    :root{
      --bg1:#07060a;
      --bg2:#150015;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --shadow: 0 18px 60px rgba(0,0,0,.62);
      --radius: 18px;

      --hot:#ff2d55;
      --glow: 0 0 22px rgba(255,45,85,.55);

      --gold:#ffd36a;
      --silver:#cfd6e6;
    }

    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(255,45,85,.18) 0%, transparent 55%),
        radial-gradient(800px 520px at 80% 20%, rgba(255,211,106,.10) 0%, transparent 60%),
        radial-gradient(700px 520px at 50% 90%, rgba(166,83,255,.10) 0%, transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    /* brilhinhos sutis no fundo */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.35) 50%, transparent 55%),
        radial-gradient(2px 2px at 70% 20%, rgba(255,255,255,.25) 50%, transparent 55%),
        radial-gradient(1px 1px at 40% 80%, rgba(255,255,255,.20) 50%, transparent 55%),
        radial-gradient(1px 1px at 85% 75%, rgba(255,255,255,.18) 50%, transparent 55%);
      opacity: .55;
      filter: blur(.2px);
      animation: twinkle 3.5s infinite alternate ease-in-out;
    }
    @keyframes twinkle{
      from{ opacity: .40; transform: translateY(0); }
      to{ opacity: .70; transform: translateY(-2px); }
    }

    .topbar{
      position:fixed; inset:18px 18px auto 18px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      z-index:3;
      pointer-events:none;
    }
    .brand, .counter{
      pointer-events:auto;
    }

    .brand{
      display:flex; gap:10px; align-items:center;
      padding:10px 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      border-radius:999px;
      box-shadow: var(--shadow);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--hot);
      box-shadow: var(--glow);
    }
    .brand small{color:var(--muted)}
    .counter{
      padding:10px 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      border-radius:999px;
      box-shadow: var(--shadow);
      color:var(--muted);
      font-variant-numeric: tabular-nums;
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* botÃ£o som */
    .soundBtn{
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:7px 10px;
      border-radius: 999px;
      cursor:pointer;
      transition:.2s transform, .2s background;
      font-size: 12px;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .soundBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.12); }

    .stage{
      position:relative;
      width:100vw; height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }

    .hint{
      max-width:720px;
      text-align:center;
      padding:18px 18px 22px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .hint h1{
      margin:0 0 8px;
      font-size: clamp(20px, 4vw, 34px);
      letter-spacing: .3px;
      text-transform: uppercase;
    }
    .hint p{
      margin:0;
      color:var(--muted);
      line-height:1.55;
      font-size: clamp(14px, 2.5vw, 16px);
    }
    .hint button{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,45,85,.16);
      color:var(--text);
      padding:10px 14px;
      border-radius: 999px;
      cursor:pointer;
      transition:.2s transform, .2s background;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .hint button:hover{ transform: translateY(-1px); background: rgba(255,45,85,.22); }

    /* Popups */
    .popup{
      position:absolute;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(16, 10, 20, .72);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      user-select:none;
      animation: pop .18s ease-out;
    }
    @keyframes pop{
      from{ transform: scale(.96); opacity:0; }
      to{ transform: scale(1); opacity:1; }
    }

    /* Glitter border vibe */
    .popup::before{
      content:"";
      position:absolute; inset:0;
      padding:1px;
      border-radius:22px;
      background: linear-gradient(135deg,
        rgba(255,45,85,.70),
        rgba(255,211,106,.55),
        rgba(255,255,255,.30),
        rgba(255,45,85,.55)
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      opacity:.62;
    }

    .popup .head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background: rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.10);
      cursor:grab;
    }
    .popup .title{
      display:flex; gap:10px; align-items:center;
      font-weight:800;
      font-size: 12px;
      letter-spacing: .8px;
      text-transform: uppercase;
      color: rgba(255,255,255,.88);
    }

    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.78);
    }

    .traffic{
      display:flex; gap:6px; align-items:center;
    }
    .traffic i{
      display:block; width:10px; height:10px; border-radius:50%;
      opacity:.9;
    }
    .traffic i:nth-child(1){ background:#ff5f57; }
    .traffic i:nth-child(2){ background:#febc2e; }
    .traffic i:nth-child(3){ background:#28c840; }

    .popup .body{
      padding:14px 14px 10px;
      color: rgba(255,255,255,.92);
      line-height:1.55;
      font-size: 15px;
    }

    .popup .body .tiny{
      display:block;
      margin-top:10px;
      color: rgba(255,255,255,.62);
      font-size: 12px;
      letter-spacing: .3px;
    }

    .popup .foot{
      display:flex; justify-content:space-between; gap:10px;
      padding:0 12px 12px;
      align-items:center;
    }

    .spark{
      font-size: 12px;
      color: rgba(255,255,255,.65);
      display:flex;
      gap:8px;
      align-items:center;
    }

    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:8px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition:.2s transform, .2s background;
      font-size: 13px;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.12); }
    .btn.primary{
      border-color: rgba(255,45,85,.55);
      background: rgba(255,45,85,.18);
      box-shadow: 0 0 0 1px rgba(255,45,85,.10), 0 0 26px rgba(255,45,85,.12);
    }
    .btn.primary:hover{ background: rgba(255,45,85,.26); }

    /* Big popup */
    .popup.big{
      width: min(820px, calc(100vw - 40px));
      border-radius: 28px;
    }
    .popup.big::before{
      border-radius: 28px;
      opacity:.75;
    }
    .popup.big .head{
      padding: 12px 14px;
    }
    .bigText{
      padding: 22px 18px 6px;
      text-align:center;
    }
    .bigText .line1{
      font-weight: 900;
      font-size: clamp(22px, 5vw, 44px);
      letter-spacing: .6px;
      text-transform: uppercase;
    }
    .bigText .line2{
      margin-top: 10px;
      font-size: clamp(14px, 2.5vw, 18px);
      color: rgba(255,255,255,.72);
    }
    .bigText .heart{
      display:inline-block;
      margin-top: 12px;
      font-size: 28px;
      filter: drop-shadow(0 0 18px rgba(255,45,85,.35));
    }

    /* Final overlay (pedido) */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:24px;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(7px);
      z-index:10;
    }
    .final{
      width:min(560px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background: rgba(16, 10, 20, .78);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding:18px 18px 16px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .final::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle, rgba(255,45,85,.20) 0%, transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .final h2{
      position:relative;
      margin:8px 0 6px;
      font-size: clamp(20px, 5vw, 34px);
      text-transform: uppercase;
      letter-spacing:.6px;
    }
    .final p{
      position:relative;
      margin:0 0 14px;
      color: var(--muted);
      line-height:1.5;
      font-size: 15px;
    }
    .actions{
      position:relative;
      display:flex; justify-content:center; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .smallnote{
      position:relative;
      margin-top:10px;
      font-size: 12px;
      color: rgba(255,255,255,.60);
    }

    /* ENCORE overlay (sÃ³ no SIM) */
    .encoreOverlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:24px;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(8px);
      z-index:20;
    }
    .encoreCard{
      width:min(820px, 100%);
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-radius: 28px;
      box-shadow: 0 18px 60px rgba(0,0,0,.65), 0 0 40px rgba(255,45,85,.16);
      padding: 22px 18px 18px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .encoreCard::before{
      content:"";
      position:absolute; inset:-35%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,45,85,.22) 0%, transparent 58%),
        radial-gradient(circle at 75% 20%, rgba(255,211,106,.12) 0%, transparent 60%),
        radial-gradient(circle at 50% 80%, rgba(255,255,255,.10) 0%, transparent 60%);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .encoreBadge{
      position:relative;
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      letter-spacing:.9px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.92);
      box-shadow: 0 0 20px rgba(255,45,85,.14);
    }
    .encoreTitle{
      position:relative;
      margin:14px 0 10px;
      font-size: clamp(24px, 3.8vw, 46px);
      line-height:1.12;
      text-transform: uppercase;
      letter-spacing:.6px;
      text-shadow: 0 0 24px rgba(255,45,85,.16);
    }
    .encoreSub{
      position:relative;
      margin:0 0 14px;
      color: rgba(255,255,255,.78);
      line-height:1.5;
      font-size: 15px;
    }

    /* ===== SHOW LIGHTS (sÃ³ no ENCORE) ===== */
    .showLights{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      border-radius: 28px;
      z-index: 0;
    }
    .beam{
      position:absolute;
      top:-40%;
      width: 140px;
      height: 220%;
      opacity:.55;
      filter: blur(0.2px);
      transform-origin: top center;
      mix-blend-mode: screen;
      background: linear-gradient(to bottom,
        rgba(255,255,255,.0) 0%,
        rgba(255,45,85,.25) 25%,
        rgba(255,211,106,.18) 55%,
        rgba(255,255,255,.0) 100%
      );
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
      animation: sweep 2.6s ease-in-out infinite alternate;
    }
    .beam.b1{ left: 10%; animation-duration: 2.2s; transform: rotate(-12deg); opacity:.45; }
    .beam.b2{ left: 35%; animation-duration: 2.8s; transform: rotate(8deg);  opacity:.55; }
    .beam.b3{ left: 60%; animation-duration: 2.4s; transform: rotate(-6deg); opacity:.50; }
    .beam.b4{ left: 82%; animation-duration: 3.0s; transform: rotate(14deg); opacity:.42; }

    @keyframes sweep{
      0%   { transform: rotate(-16deg) translateY(0); opacity:.35; }
      50%  { transform: rotate(10deg) translateY(6px); opacity:.55; }
      100% { transform: rotate(-8deg) translateY(0); opacity:.40; }
    }

    .spot{
      position:absolute;
      top: -40px;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      filter: blur(6px);
      opacity:.35;
      mix-blend-mode: screen;
      animation: floaty 2.8s ease-in-out infinite alternate;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.55), rgba(255,45,85,.18), transparent 65%);
    }
    .spot.s1{ left: 6%;  animation-duration: 2.4s; }
    .spot.s2{ left: 40%; animation-duration: 3.0s; opacity:.28; }
    .spot.s3{ left: 72%; animation-duration: 2.6s; }

    @keyframes floaty{
      from{ transform: translateY(0) scale(1); }
      to  { transform: translateY(14px) scale(1.06); }
    }

    .strobe{
      position:absolute;
      inset:0;
      background: rgba(255,255,255,.08);
      opacity:0;
      animation: strobe 1.2s linear infinite;
      mix-blend-mode: screen;
    }
    @keyframes strobe{
      0%, 86%, 100% { opacity: 0; }
      88% { opacity: .32; }
      90% { opacity: 0; }
      92% { opacity: .18; }
      94% { opacity: 0; }
    }

    .encoreCard > *:not(.showLights){
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body>
  <!-- MÃºsica (coloque o arquivo made_for_lovin_you.mp3 na mesma pasta do index.html) -->
  <audio id="bgMusic" preload="auto" loop>
    <source src="made_for_lovin_you.mp3" type="audio/mpeg">
  </audio>

  <!-- Efeitos (coloque crowd_cheer.mp3 e applause.mp3 na mesma pasta do index.html) -->
  <audio id="crowdCheer" preload="auto">
    <source src="crowd_cheer.mp3" type="audio/mpeg">
  </audio>

  <audio id="applause" preload="auto">
    <source src="applause.mp3" type="audio/mpeg">
  </audio>

  <div class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <div>
        <div style="font-weight:900; font-size:13px; letter-spacing:.7px; text-transform:uppercase;">Tour do CoraÃ§Ã£o</div>
        <small>Feche todos os pop-ups pra desbloquear o final</small>
      </div>
    </div>

    <div class="counter" id="counter">
      <span>0/0</span>
      <button class="soundBtn" id="soundBtn" title="Ativar/pausar mÃºsica">
        ğŸ”‡ <span id="soundLabel">Som</span>
      </button>
    </div>
  </div>

  <div class="stage">
    <div class="hint" id="hint">
      <h1>EstÃ¡ preparada para o possÃ­vel inÃ­cio da nossa turnÃª? ğŸ¸</h1>
      <p>
        Vai chover pop-up. Fecha tudo e eu te mostro o Ãºltimo. <br/>
      </p>
      <button id="startBtn">Iniciar o Show ğŸ¤˜</button>
    </div>
  </div>

  <!-- Overlay final (pedido) -->
  <div class="overlay" id="overlay">
    <div class="final">
      <div style="font-size:34px; position:relative;">ğŸ’˜</div>
      <h2>Aceita namorar cmg minha chatinha?</h2>
      <p>
        Eu nÃ£o consigo prometer perfeiÃ§Ã£o, mas consigo prometer presenÃ§a,
        carinho e um abrigo so seu ao meu lado para o resto de nossas vidas.
      </p>
      <div class="actions">
        <button class="btn primary" id="yesBtn">Sim</button>
        <button class="btn" id="thinkBtn">Preciso pensar</button>
      </div>
      <div class="smallnote" id="note"></div>
    </div>
  </div>

  <!-- ENCORE: aparece sÃ³ se clicar SIM -->
  <div class="encoreOverlay" id="encoreOverlay">
    <div class="encoreCard">
      <div class="showLights" aria-hidden="true">
        <div class="spot s1"></div>
        <div class="spot s2"></div>
        <div class="spot s3"></div>

        <div class="beam b1"></div>
        <div class="beam b2"></div>
        <div class="beam b3"></div>
        <div class="beam b4"></div>

        <div class="strobe"></div>
      </div>

      <div class="encoreBadge">ENCORE ğŸ’‹</div>
      <div class="encoreTitle">
        Esse ingresso nÃ£o Ã© sÃ³ lembranÃ§a.<br/>
        Ã‰ o comeÃ§o da nossa turnÃª juntos.
      </div>
      <div class="encoreSub">Agora oficialmente nossa turnÃª se inicia. ğŸ–¤ğŸ¸</div>
      <div class="actions">
        <button class="btn primary" id="encoreClose">OK, minha estrela â­</button>
      </div>
      <div class="smallnote">ps: essa parte sÃ³ aparece no â€œSimâ€ ğŸ˜Œ</div>
    </div>
  </div>

  <script>
    // âœ¨ PERSONALIZE AQUI âœ¨
    const messages = [
      "VocÃª tem um jeito raro de deixar tudo mais bonito sÃ³ por existir.",
      "Eu gosto de vocÃª no detalhe: no riso, na calma, no jeitinho.",
      "Se eu fosse mÃºsica, eu ia querer ser a sua favorita.",
      "VocÃª Ã© aquela parte do meu dia que eu espero sem perceber.",
      "Quando vocÃª aparece, atÃ© o silÃªncio fica confortÃ¡vel.",
      "Eu gosto do jeito que vocÃª cuida do mundo, mesmo sem notar.",
      "Tem carinho em vocÃª que parece luz acesa.",
      "Eu penso em vocÃª e meu peito fica mais leve. Isso Ã© injusto (e Ã³timo).",
      "VocÃª Ã© a prova viva de que o simples pode ser incrÃ­vel.",
      "Eu gosto de vocÃª com uma certeza calma, daquelas que aquecem.",
      "Se eu pudesse, eu te guardava num lugar seguro: bem aqui comigo.",
      "VocÃª faz meu cÃ©rebro virar confete e minha voz virar sorriso.",
      "VocÃª Ã© meu tipo de caos bom: o que melhora tudo.",
      "Eu queria te dizer isso pessoalmente, mas achei mais divertido assim.",
      "VocÃª merece um amor que nÃ£o some, nÃ£o hesita, nÃ£o economiza.",
      "Obrigada por existir do jeitinho que existe (sim, eu gosto muito).",
      "Se o mundo fosse uma playlist, vocÃª seria a mÃºsica que eu repito.",
      "Meu coraÃ§Ã£o pediu para avisar: ele gosta de vocÃª faz tempo.",
      "VocÃª Ã© meu pensamento favorito quando eu deveria estar focando.",
      "Seu nome combina com a palavra â€˜casaâ€™.",
      "Okâ€¦ tÃ¡ ficando sÃ©rio. Continua fechando. ğŸ‘€",
      "Quase lÃ¡. Ãšltima fase chegando. ğŸ’‹",
    ];

    // Aumenta pop-ups para "encher a tela"
    const TARGET_POPUPS = 22;     // quantos pop-ups no total (tela cheia)
    const POPUPS_DELAY_MS = 80;   // velocidade que eles aparecem

    // Popup gigante prÃ©-final
    const BIG_POPUP_TEXT = "I was made for lovinâ€™ you baby";
    const BIG_POPUP_SUB  = "Agora fecha esse e vÃª o que eu queria te perguntarâ€¦";

    const stage = document.querySelector(".stage");
    const startBtn = document.getElementById("startBtn");
    const hint = document.getElementById("hint");
    const overlay = document.getElementById("overlay");
    const counter = document.getElementById("counter");
    const note = document.getElementById("note");
    const yesBtn = document.getElementById("yesBtn");
    const thinkBtn = document.getElementById("thinkBtn");

    // MÃºsica
    const bgMusic = document.getElementById("bgMusic");
    const soundBtn = document.getElementById("soundBtn");
    const soundLabel = document.getElementById("soundLabel");
    let soundOn = false;

    // Efeitos
    const crowdCheer = document.getElementById("crowdCheer");
    const applause = document.getElementById("applause");

    function playSfxSafe(audioEl, { volume = 0.7 } = {}){
      if(!audioEl) return;
      try{
        audioEl.pause();
        audioEl.currentTime = 0;
        audioEl.volume = volume;
        audioEl.play().catch(()=>{});
      }catch(e){}
    }

    function setSoundUI(){
      soundBtn.firstChild.textContent = soundOn ? "ğŸ”Š " : "ğŸ”‡ ";
      soundLabel.textContent = soundOn ? "Pausar" : "Som";
      soundBtn.setAttribute("aria-pressed", soundOn ? "true" : "false");
    }

    async function toggleSound(){
      try{
        if(!soundOn){
          bgMusic.volume = 0.35;
          await bgMusic.play();
          soundOn = true;
        }else{
          bgMusic.pause();
          soundOn = false;
        }
        setSoundUI();
      }catch(e){
        soundOn = false;
        setSoundUI();
      }
    }

    soundBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleSound();
    });

    let closedCount = 0;
    let z = 5;
    let totalToClose = 0;

    function updateCounter(){
      const remaining = Math.max(0, totalToClose - closedCount);
      counter.querySelector("span").textContent = `${remaining}/${totalToClose}`;
    }

    function rand(min, max){ return Math.random() * (max - min) + min; }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function placeOnScreen(el, wGuess=360, hGuess=180){
      const maxX = Math.max(10, window.innerWidth - 10 - wGuess);
      const maxY = Math.max(70, window.innerHeight - 10 - hGuess);
      const x = rand(10, maxX);
      const y = rand(70, maxY);
      el.style.left = `${x}px`;
      el.style.top  = `${y}px`;
    }

    function createPopup(text, idx){
      const el = document.createElement("div");
      el.className = "popup";
      el.style.zIndex = z++;
      el.style.width = `${Math.floor(rand(300, 380))}px`;

      el.innerHTML = `
        <div class="head">
          <div class="title">
            <span>LOVE POP-UP</span>
            <span class="badge">#${String(idx+1).padStart(2,"0")}</span>
          </div>
          <div class="traffic" aria-hidden="true"><i></i><i></i><i></i></div>
        </div>
        <div class="body">
          ${escapeHtml(text)}
          <span class="tiny">feche para continuar âœ¦</span>
        </div>
        <div class="foot">
          <div class="spark">ğŸ’‹ <span style="opacity:.75">KISS vibes</span></div>
          <button class="btn primary" data-action="close">Fechar</button>
        </div>
      `;

      stage.appendChild(el);
      const rect = el.getBoundingClientRect();
      placeOnScreen(el, rect.width, rect.height);

      el.addEventListener("mousedown", () => el.style.zIndex = z++);

      el.querySelector('[data-action="close"]').addEventListener("click", () => {
        el.remove();
        closedCount++;
        updateCounter();
        checkProgress();
      });

      dragElement(el, el.querySelector(".head"));
      return el;
    }

    function createBigPopup(){
      const el = document.createElement("div");
      el.className = "popup big";
      el.style.zIndex = z++;

      el.innerHTML = `
        <div class="head">
          <div class="title">
            <span>FINAL TRACK</span>
            <span class="badge">SPECIAL</span>
          </div>
          <div class="traffic" aria-hidden="true"><i></i><i></i><i></i></div>
        </div>
        <div class="bigText">
          <div class="line1">${escapeHtml(BIG_POPUP_TEXT)}</div>
          <div class="line2">${escapeHtml(BIG_POPUP_SUB)}</div>
          <div class="heart">ğŸ’˜</div>
        </div>
        <div class="foot">
          <div class="spark">ğŸ¸ <span style="opacity:.75">close pra revelar</span></div>
          <button class="btn primary" data-action="close">Fechar</button>
        </div>
      `;

      stage.appendChild(el);

      const rect = el.getBoundingClientRect();
      el.style.left = `${Math.max(10, (window.innerWidth - rect.width)/2)}px`;
      el.style.top  = `${Math.max(80, (window.innerHeight - rect.height)/2)}px`;

      el.addEventListener("mousedown", () => el.style.zIndex = z++);

      el.querySelector('[data-action="close"]').addEventListener("click", () => {
        el.remove();
        closedCount++;
        updateCounter();
        checkProgress(true);
      });

      dragElement(el, el.querySelector(".head"));
    }

    let bigShown = false;
    let finalShown = false;

    function checkProgress(){
      if(!bigShown && closedCount >= (totalToClose - 1)){
        bigShown = true;
        setTimeout(createBigPopup, 250);
        return;
      }

      if(bigShown && !finalShown && closedCount >= totalToClose){
        finalShown = true;
        setTimeout(() => overlay.style.display = "flex", 250);
      }
    }

    function dragElement(el, handle){
      let startX=0, startY=0, startLeft=0, startTop=0, dragging=false;

      handle.addEventListener("mousedown", (e) => {
        dragging=true;
        handle.style.cursor="grabbing";
        el.style.zIndex = z++;
        startX = e.clientX;
        startY = e.clientY;
        const rect = el.getBoundingClientRect();
        startLeft = rect.left;
        startTop  = rect.top;
        e.preventDefault();
      });

      window.addEventListener("mousemove", (e) => {
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        const newLeft = Math.min(window.innerWidth - el.offsetWidth - 8, Math.max(8, startLeft + dx));
        const newTop  = Math.min(window.innerHeight - el.offsetHeight - 8, Math.max(60, startTop + dy));
        el.style.left = newLeft + "px";
        el.style.top  = newTop + "px";
      });

      window.addEventListener("mouseup", () => {
        if(!dragging) return;
        dragging=false;
        handle.style.cursor="grab";
      });
    }

    function start(){
      hint.style.display = "none";
      overlay.style.display = "none";
      document.getElementById("encoreOverlay").style.display = "none";
      note.textContent = "";
      yesBtn.disabled = false;
      thinkBtn.disabled = false;

      if(soundOn){
        bgMusic.volume = 0.35;
        bgMusic.play().catch(()=>{});
      }

      closedCount = 0;
      bigShown = false;
      finalShown = false;

      document.querySelectorAll(".popup").forEach(p => p.remove());

      const smallCount = Math.max(8, TARGET_POPUPS - 1);
      totalToClose = smallCount + 1;
      updateCounter();

      const pool = [];
      for(let i=0; i<smallCount; i++){
        pool.push(messages[i % messages.length]);
      }

      pool.forEach((m, i) => {
        setTimeout(() => createPopup(m, i), POPUPS_DELAY_MS * i);
      });
    }

    startBtn.addEventListener("click", async () => {
      if(!soundOn){
        try{
          bgMusic.volume = 0.35;
          await bgMusic.play();
          soundOn = true;
          setSoundUI();
        }catch(e){}
      }
      start();
    });

    function showEncore(){
      const encore = document.getElementById("encoreOverlay");
      encore.style.display = "flex";

      // plateia vem abaixo ğŸ‰
      playSfxSafe(crowdCheer, { volume: 0.85 });

      // aplausos entram logo depois
      setTimeout(() => playSfxSafe(applause, { volume: 0.75 }), 650);

      // boost rÃ¡pido na mÃºsica
      if(soundOn){
        const original = bgMusic.volume;
        bgMusic.volume = Math.min(0.55, original + 0.15);
        setTimeout(() => { bgMusic.volume = original; }, 2000);
      }
    }

    document.getElementById("encoreClose").addEventListener("click", () => {
      document.getElementById("encoreOverlay").style.display = "none";

      if(crowdCheer){ crowdCheer.pause(); crowdCheer.currentTime = 0; }
      if(applause){ applause.pause(); applause.currentTime = 0; }
    });

    yesBtn.addEventListener("click", () => {
      note.textContent = "EntÃ£o vem cÃ¡â€¦ agora Ã© oficialmente nÃ³s dois ğŸ’˜";
      yesBtn.disabled = true;
      thinkBtn.disabled = true;

      setTimeout(showEncore, 350);
    });

    thinkBtn.addEventListener("click", () => {
      note.textContent = "TÃ¡ tudo bem. Eu gosto de vocÃª com calma tambÃ©m ğŸ™‚";
      yesBtn.disabled = true;
      thinkBtn.disabled = true;
    });

    setSoundUI();
    updateCounter();
  </script>
</body>
</html>
